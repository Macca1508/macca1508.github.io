<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizzatore GPX - OpenStreetMap</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 { font-size: 2rem; margin-bottom: 0.5rem; font-weight: 700; }
        .header p { opacity: 0.9; font-size: 1.1rem; }

        .controls {
            padding: 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-section { flex: 1; min-width: 300px; }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-button {
            padding: 1rem 2rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: background 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-button:hover {
            background: #1d4ed8;
        }

        .clear-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            background: #ef4444;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease;
            display: none;
        }

        .clear-btn:hover { background: #dc2626; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            background: #f8fafc;
            display: none;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .stat-card:hover { transform: translateY(-2px); }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .stat-card:nth-child(1) .stat-number { color: #3b82f6; }
        .stat-card:nth-child(2) .stat-number { color: #10b981; }
        .stat-card:nth-child(3) .stat-number { color: #f59e0b; }
        .stat-card:nth-child(4) .stat-number { color: #8b5cf6; }

        .summary-section {
            padding: 1.5rem;
            background: #f8fafc;
            display: none;
        }

        .summary-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1e293b;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .summary-table th,
        .summary-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-table th {
            background: #475569;
            color: white;
            font-weight: 600;
        }

        .summary-table tr:hover { background: #f8fafc; }
        .summary-table tr:nth-child(even) { background: #f9fafb; }

        .map-container {
            height: 600px;
            margin: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: none;
        }

        #map { height: 100%; width: 100%; }

        .message {
            margin: 1rem 1.5rem;
            padding: 1rem;
            border-radius: 6px;
            font-weight: 500;
            display: none;
        }

        .message.success {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #166534;
        }

        .message.error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        @media (max-width: 768px) {
            body { padding: 0.5rem; }
            .header { padding: 1.5rem; }
            .header h1 { font-size: 1.5rem; }
            .controls { padding: 1rem; flex-direction: column; }
            .file-section { min-width: auto; width: 100%; }
            .map-container { margin: 1rem; height: 400px; }
            .stats { padding: 1rem; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .summary-table { font-size: 0.875rem; }
            .summary-table th, .summary-table td { padding: 0.75rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è Visualizzatore GPX</h1>
            <p>Carica e visualizza i tuoi file GPX su OpenStreetMap</p>
        </div>

        <div class="controls">
            <div class="file-section">
                <div class="file-input-wrapper">
                    <input type="file" id="gpxFile" accept=".gpx" class="file-input">
                    <button class="file-button">üìÅ Seleziona file GPX</button>
                </div>
            </div>
            <button id="clearBtn" class="clear-btn">üóëÔ∏è Cancella Report</button>
        </div>

        <div id="message" class="message"></div>

        <div id="summarySection" class="summary-section">
            <div class="summary-title">üìà Report File GPX Caricati</div>
            <div style="overflow-x: auto;">
                <table id="summaryTable" class="summary-table">
                    <thead>
                        <tr>
                            <th>Nome File</th>
                            <th>Punti</th>
                            <th>Distanza (km)</th>
                            <th>Dislivello+ (m)</th>
                            <th>Durata</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="stats" class="stats">
            <div class="stat-card">
                <div id="totalPoints" class="stat-number">0</div>
                <div class="stat-label">üìç Punti totali</div>
            </div>
            <div class="stat-card">
                <div id="distance" class="stat-number">0</div>
                <div class="stat-label">üõ£Ô∏è Distanza (km)</div>
            </div>
            <div class="stat-card">
                <div id="elevation" class="stat-number">0</div>
                <div class="stat-label">‚õ∞Ô∏è Dislivello (m)</div>
            </div>
            <div class="stat-card">
                <div id="duration" class="stat-number">-</div>
                <div class="stat-label">‚è±Ô∏è Tempo percorso</div>
            </div>
        </div>

        <div id="mapContainer" class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        class GPXViewer {
            constructor() {
                this.map = null;
                this.trackLayer = null;
                this.summaryData = [];
                this.colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF8A65', '#BA68C8'];
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadSavedData();
            }

            setupEventListeners() {
                const fileInput = document.getElementById('gpxFile');
                const clearBtn = document.getElementById('clearBtn');

                fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                clearBtn.addEventListener('click', () => this.clearReport());
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) this.handleFile(file);
            }

            async handleFile(file) {
                try {
                    const content = await this.readFile(file);
                    this.parseGPX(content, file.name);
                    this.showMessage('File caricato con successo!', 'success');
                } catch (error) {
                    this.showMessage(`Errore: ${error.message}`, 'error');
                }
            }

            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Errore nella lettura del file'));
                    reader.readAsText(file);
                });
            }

            parseGPX(content, fileName) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(content, 'text/xml');

                if (doc.querySelector('parsererror')) {
                    throw new Error('File GPX non valido');
                }

                const tracks = this.extractTracks(doc);
                if (tracks.length === 0) {
                    throw new Error('Nessun dato geografico trovato');
                }

                this.displayOnMap(tracks, fileName);
            }

            extractTracks(doc) {
                const tracks = [];
                const trkElements = doc.querySelectorAll('trk');
                
                trkElements.forEach(trk => {
                    trk.querySelectorAll('trkseg').forEach(trkseg => {
                        const points = Array.from(trkseg.querySelectorAll('trkpt'))
                            .map((trkpt, i) => {
                                const lat = parseFloat(trkpt.getAttribute('lat'));
                                const lon = parseFloat(trkpt.getAttribute('lon'));
                                
                                if (isNaN(lat) || isNaN(lon)) return null;
                                
                                const eleEl = trkpt.querySelector('ele');
                                const timeEl = trkpt.querySelector('time');
                                
                                return {
                                    lat,
                                    lon,
                                    ele: eleEl ? parseFloat(eleEl.textContent) : null,
                                    time: timeEl ? new Date(timeEl.textContent) : null,
                                    index: i + 1
                                };
                            })
                            .filter(Boolean);
                        
                        if (points.length > 0) tracks.push(points);
                    });
                });

                return tracks;
            }

            displayOnMap(tracks, fileName) {
                this.initMap();
                this.clearTrackLayer();

                const stats = this.calculateStats(tracks);
                this.renderTracks(tracks, fileName, stats);
                this.updateDisplay(fileName, stats);
                this.fitMapBounds(tracks);
                this.saveData();
            }

            initMap() {
                if (!this.map) {
                    this.map = L.map('map').setView([45.4642, 9.1900], 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(this.map);
                }
            }

            clearTrackLayer() {
                if (this.trackLayer) {
                    this.map.removeLayer(this.trackLayer);
                }
                this.trackLayer = L.layerGroup().addTo(this.map);
            }

            calculateStats(tracks) {
                let totalDistance = 0, totalElevation = 0, totalPoints = 0;
                let startTime = null, endTime = null;

                tracks.forEach(track => {
                    totalPoints += track.length;
                    
                    for (let i = 1; i < track.length; i++) {
                        totalDistance += this.haversineDistance(track[i-1], track[i]);
                        
                        if (track[i-1].ele !== null && track[i].ele !== null) {
                            const elevDiff = track[i].ele - track[i-1].ele;
                            if (elevDiff > 0) totalElevation += elevDiff;
                        }
                    }

                    const times = track.filter(p => p.time).map(p => p.time);
                    if (times.length > 0) {
                        const trackStart = new Date(Math.min(...times));
                        const trackEnd = new Date(Math.max(...times));
                        if (!startTime || trackStart < startTime) startTime = trackStart;
                        if (!endTime || trackEnd > endTime) endTime = trackEnd;
                    }
                });

                const duration = startTime && endTime ? 
                    this.formatDuration(endTime - startTime) : 'N/D';

                return { totalPoints, totalDistance, totalElevation, duration };
            }

            renderTracks(tracks, fileName, stats) {
                tracks.forEach((track, i) => {
                    const color = this.colors[i % this.colors.length];
                    const latLngs = track.map(p => [p.lat, p.lon]);
                    
                    const polyline = L.polyline(latLngs, {
                        color,
                        weight: 4,
                        opacity: 0.8
                    }).addTo(this.trackLayer);

                    polyline.bindPopup(`
                        <div>
                            <h4 style="margin: 0 0 10px 0; color: ${color};">üõ§Ô∏è ${fileName}</h4>
                            <p><strong>Punti:</strong> ${track.length}</p>
                            <p><strong>Distanza:</strong> ${stats.totalDistance.toFixed(2)} km</p>
                            <p><strong>Dislivello+:</strong> ${Math.round(stats.totalElevation)} m</p>
                        </div>
                    `);
                });
            }

            updateDisplay(fileName, stats) {
                this.addToSummary({ fileName, ...stats });
                this.updateStats(stats);
                this.showSections();
            }

            addToSummary(data) {
                const existingIndex = this.summaryData.findIndex(item => item.fileName === data.fileName);
                
                if (existingIndex === -1) {
                    this.summaryData.push(data);
                } else {
                    this.summaryData[existingIndex] = data;
                }
                
                this.updateSummaryTable();
            }

            updateSummaryTable() {
                const tbody = document.getElementById('summaryTableBody');
                tbody.innerHTML = this.summaryData.map(data => `
                    <tr>
                        <td><strong>${data.fileName}</strong></td>
                        <td>${data.totalPoints}</td>
                        <td>${data.totalDistance.toFixed(2)}</td>
                        <td>${Math.round(data.totalElevation)}</td>
                        <td>${data.duration}</td>
                    </tr>
                `).join('');
            }

            updateStats({ totalPoints, totalDistance, totalElevation, duration }) {
                document.getElementById('totalPoints').textContent = totalPoints;
                document.getElementById('distance').textContent = totalDistance.toFixed(2);
                document.getElementById('elevation').textContent = Math.round(totalElevation);
                document.getElementById('duration').textContent = duration;
            }

            showSections() {
                ['mapContainer', 'stats', 'summarySection', 'clearBtn'].forEach(id => {
                    const el = document.getElementById(id);
                    el.style.display = id === 'clearBtn' ? 'inline-block' : 
                                      id === 'stats' ? 'grid' : 'block';
                });
                
                setTimeout(() => this.map?.invalidateSize(), 100);
            }

            fitMapBounds(tracks) {
                const allPoints = tracks.flat().map(p => [p.lat, p.lon]);
                if (allPoints.length > 0) {
                    this.map.fitBounds(L.latLngBounds(allPoints), { padding: [40, 40] });
                }
            }

            haversineDistance(p1, p2) {
                const R = 6371;
                const dLat = (p2.lat - p1.lat) * Math.PI / 180;
                const dLon = (p2.lon - p1.lon) * Math.PI / 180;
                const a = Math.sin(dLat/2) ** 2 + 
                         Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) * 
                         Math.sin(dLon/2) ** 2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }

            formatDuration(ms) {
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                return hours > 0 ? `${hours}h ${minutes}m` :
                       minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            }

            clearReport() {
                if (!confirm('Sei sicuro di voler cancellare tutto il report?')) return;
                
                this.summaryData = [];
                this.updateSummaryTable();
                
                ['summarySection', 'clearBtn'].forEach(id => {
                    document.getElementById(id).style.display = 'none';
                });
                
                this.clearSavedData();
                this.showMessage('Report cancellato con successo', 'success');
            }

            saveData() {
                window.gpxReportData = this.summaryData;
            }

            loadSavedData() {
                if (window.gpxReportData?.length > 0) {
                    this.summaryData = window.gpxReportData;
                    this.updateSummaryTable();
                    ['summarySection', 'clearBtn'].forEach(id => {
                        const el = document.getElementById(id);
                        el.style.display = id === 'clearBtn' ? 'inline-block' : 'block';
                    });
                }
            }

            clearSavedData() {
                delete window.gpxReportData;
            }

            showMessage(text, type) {
                const msg = document.getElementById('message');
                msg.textContent = text;
                msg.className = `message ${type}`;
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => new GPXViewer());
    </script>
</body>
</html>